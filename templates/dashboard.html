{% extends "base.html" %}
{% block content %}

{% set profit_is_pos = (profit or 0) >= 0 %}
{% set hdep_show = hen_day_pct_clamped %}
{% set stock_level =
  'text-bg-success' if eggs_stock >= (eggs_per_rack*3)
  else ('text-bg-warning' if eggs_stock >= eggs_per_rack else 'text-bg-danger')
%}
{% set stock_label =
  'Aman' if eggs_stock >= (eggs_per_rack*3)
  else ('Menipis' if eggs_stock >= eggs_per_rack else 'Kritis')
%}

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h4 class="fw-bold mb-0">Dashboard</h4>
    <div class="text-muted small">Ringkasan pemasukan/pengeluaran, telur, ayam, dan kolam.</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('transactions') }}">Transaksi</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('flocks') }}">Input Ayam</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('ponds') }}">Input Kolam</a>
  </div>
</div>

<div class="row g-3">
  <!-- KPI Keuangan -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="kpi-title">Pemasukan</div>
        <div class="kpi-value">Rp {{ "{:,.0f}".format(total_in) }}</div>
        <div class="small text-muted mt-1">Akumulasi transaksi tipe <b>IN</b>.</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="kpi-title">Pengeluaran</div>
        <div class="kpi-value">Rp {{ "{:,.0f}".format(total_out) }}</div>
        <div class="small text-muted mt-1">Akumulasi transaksi tipe <b>OUT</b>.</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="kpi-title">Laba / Rugi</div>
        <div class="kpi-value {% if profit_is_pos %}text-success{% else %}text-danger{% endif %}">
          Rp {{ "{:,.0f}".format(profit) }}
        </div>
        <div class="small text-muted mt-1">
          {% if profit_is_pos %}Tren positif.{% else %}Perlu evaluasi biaya/penjualan.{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- TELUR -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="d-flex align-items-center gap-2">
              <div class="fw-semibold">Telur</div>
              <span class="badge {{ stock_level }}">Stok {{ stock_label }}</span>
              <span class="badge text-bg-secondary">1 rak = {{ eggs_per_rack }} butir</span>
            </div>

            <div class="d-flex align-items-baseline gap-2 mt-2">
              <div class="display-6 fw-bold mb-0">{{ stock_racks }}</div>
              <div class="text-muted">rak</div>
            </div>
            <div class="text-muted">
              + {{ stock_eggs_rem }} butir <span class="small">(≈ {{ eggs_stock }} butir)</span>
            </div>

            {% if stock_warning %}
              <div class="small text-danger mt-2">
                ⚠️ Stok terhitung negatif. Cek: produksi vs transaksi penjualan (raw: {{ eggs_stock_raw }}).
              </div>
            {% endif %}
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-4">
            <div class="small text-muted">Produksi hari ini</div>
            <div class="fw-bold">{{ eggs_today }} butir</div>
          </div>
          <div class="col-4">
            <div class="small text-muted">Terjual hari ini</div>
            <div class="fw-bold">{{ "%.2f"|format(racks_sold_today) }} rak</div>
            <div class="small text-muted">≈ {{ eggs_sold_today }} butir</div>
          </div>
          <div class="col-4">
            <div class="small text-muted">Rata-rata 7 hari</div>
            <div class="fw-bold">{{ avg_eggs_7d }} butir/hari</div>
          </div>
        </div>

        <div class="mt-3 small text-muted">
          Total produksi: <b>{{ eggs_produced }}</b> • Total terjual: <b>{{ "%.2f"|format(racks_sold) }}</b> rak (≈ <b>{{ eggs_sold }}</b> butir)
        </div>
      </div>
    </div>
  </div>

  <!-- AYAM -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-semibold">Ayam</div>
            <div class="d-flex align-items-baseline gap-2 mt-2">
              <div class="display-6 fw-bold mb-0">{{ chicken_current }}</div>
              <div class="text-muted">ekor aktif</div>
            </div>

            {% if chicken_warning %}
              <div class="small text-danger mt-2">
                ⚠️ Jumlah ayam terhitung negatif (raw: {{ chicken_current_raw }}). Cek jumlah awal & kematian.
              </div>
            {% endif %}
          </div>

          <span class="badge
            {% if hen_day_pct > 100 %}text-bg-danger
            {% elif hdep_show >= 80 %}text-bg-success
            {% elif hdep_show >= 60 %}text-bg-warning
            {% else %}text-bg-secondary{% endif %}">
            Hen-Day: {{ hdep_show }}%
          </span>
        </div>

        {% if hen_day_pct > 100 %}
          <div class="small text-danger mt-2">
            ⚠️ HDEP > 100% ({{ hen_day_pct }}%). Biasanya karena input telur hari ini terlalu besar atau jumlah ayam aktif belum sesuai.
          </div>
        {% endif %}

        <div class="mt-3">
          <div class="small text-muted mb-1">Hen-Day Egg Production (HDEP)</div>
          <div class="progress" role="progressbar" aria-valuenow="{{ hdep_show }}" aria-valuemin="0" aria-valuemax="100" style="height: 10px;">
            <div class="progress-bar" style="width: {{ hdep_show }}%"></div>
          </div>
          <div class="d-flex justify-content-between small text-muted mt-1">
            <span>{{ eggs_today }} telur / {{ chicken_current }} ayam</span>
            <span>{{ hdep_show }}%</span>
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-6">
            <div class="small text-muted">Mati hari ini</div>
            <div class="fw-bold">{{ dead_today }} ekor</div>
          </div>
          <div class="col-6">
            <div class="small text-muted">Mortalitas 7 hari</div>
            <div class="fw-bold">{{ dead_7d }} ekor</div>
            <div class="small text-muted">≈ {{ mortality_7d_pct }}%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Kolam -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center gap-2">
          <div>
            <div class="fw-semibold">Kolam Bulat (6 Kolam)</div>
            <div class="small text-muted">Kapasitas dihitung dari volume (m³).</div>
          </div>
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('ponds') }}">Kelola Kolam</a>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover align-middle">
            <thead>
              <tr>
                <th>Kolam</th>
                <th class="text-end">Volume (m³)</th>
                <th class="text-end">Isi (ekor)</th>
                <th class="text-end">Kapasitas (ekor)</th>
                <th class="text-end">Kapasitas (kg)</th>
                <th class="text-end">Usage</th>
              </tr>
            </thead>
            <tbody>
            {% for x in pond_cards %}
              <tr>
                <td><a class="text-decoration-none" href="{{ url_for('pond_detail', pond_id=x.pond.id) }}">{{ x.pond.name }}</a></td>
                <td class="text-end">{{ x.vol }}</td>
                <td class="text-end">{{ x.current }}</td>
                <td class="text-end">{{ x.cap_fish }}</td>
                <td class="text-end">{{ x.cap_kg }}</td>
                <td class="text-end">
                  <span class="badge {% if x.usage >= 90 %}text-bg-danger{% elif x.usage >= 70 %}text-bg-warning{% else %}text-bg-success{% endif %}">
                    {{ x.usage }}%
                  </span>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}
